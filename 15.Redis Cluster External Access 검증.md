# < Redis Cluster External Access 검증 >



K8s 에 Redis Cluster 를 설치하고 외부에서 접근가능 여부를 분석한다.





# 1. helm Install



## 1) 준비



### (1) helm search

추가된 bitnami repo에서 redis-cluster 를 찾는다.

```sh
$ helm repo update


$ helm search repo redis
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
bitnami/redis           17.11.3         7.0.11          Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster   8.6.2           7.0.11          Redis(R) is an open source, scalable, distribut...
---
# 2024.02.21
bitnami/redis                   18.7.0          7.2.4           Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster           9.2.0           7.2.4           Redis(R) is an open source, scalable, distribut...


```

bitnami/redis chart 를 이용할 것이다.



### (2) helm fetch

```sh

$ helm fetch bitnami/redis-cluster

$ ll
-rw-r--r-- 1 song song  89860 Feb 21 22:07 redis-cluster-9.5.2.tgz


$ tar -xzvf redis-cluster-9.5.2.tgz

$ cd redis-cluster/


```







### (3) values.yaml 확인



````yaml

$ vi values.yaml

...


  73 image:
  74   registry: docker.io
  75   repository: bitnami/redis-cluster
  76   tag: 7.2.4-debian-11-r5
...

 843   externalAccess:
 844     ## @param cluster.externalAccess.enabled Enable access to the Redis
 845     ##
 846     enabled: false
 847     ## @param cluster.externalAccess.hostMode Set cluster preferred endpoint type as hostname
 848     ## ref: https://github.com/redis/redis/pull/9530
 849     ##
 850     hostMode: false
 851     service:
 852       ## @param cluster.externalAccess.service.disableLoadBalancerIP Disable use of `Service.spec.loadBalancerIP`
 853       ##
 854       disableLoadBalancerIP: false
 855       ## @param cluster.externalAccess.service.loadBalancerIPAnnotaion Name of annotation to specify fixed IP for service in. Disables `Service.spec.loadBalancerIP` if not empty
 856       ##
 857       loadBalancerIPAnnotaion: ""
 858       ## @param cluster.externalAccess.service.type Type for the services used to expose every Pod
 859       ## At this moment only LoadBalancer is supported
 860       ##
 861       type: LoadBalancer
 862       ## @param cluster.externalAccess.service.port Port for the services used to expose every Pod
 863       ##
 864       port: 6379
 865       ## @param cluster.externalAccess.service.loadBalancerIP Array of load balancer IPs for each Redis&reg; node. Length must be the same as cluster.nodes
 866       ##
 867       loadBalancerIP: []
 868       ## @param cluster.externalAccess.service.loadBalancerSourceRanges Service Load Balancer sources
 869       ## ref: https://kubernetes.io/docs/tasks/access-application-cluster/configure-cloud-provider-firewall/#restrict-access-for-loadbalancer-service
 870       ## e.g:
 871       ## loadBalancerSourceRanges:
 872       ##   - 10.10.10.0/24
 873       ##
 874       loadBalancerSourceRanges: []
 875       ## @param cluster.externalAccess.service.annotations Annotations to add to the services used to expose every Pod of the Redis&reg; Cluster
 876       ##
 877       annotations: {}
 
 ...
 
 
````





## 2) helm install



### (1) install

```sh
# helm install
# master 2, slave 3 실행

# dry-run
$ helm -n redis-cluster install ds-redis bitnami/redis-cluster \
    --set password=new1234 \
    --set persistence.enabled=false \
    --set metrics.enabled=false \
    --set cluster.nodes=6 \
    --set cluster.replicas=1 \
    --set cluster.externalAccess.enabled=true \
    --set cluster.externalAccess.service.type=LoadBalancer \
    --set cluster.externalAccess.service.loadBalancerIP[0]=rc0.52.78.167.68.nip.io \
    --set cluster.externalAccess.service.loadBalancerIP[1]=rc1.52.78.167.68.nip.io \
    --set cluster.externalAccess.service.loadBalancerIP[2]=rc2.52.78.167.68.nip.io \
    --set cluster.externalAccess.service.loadBalancerIP[3]=rc3.52.78.167.68.nip.io \
    --set cluster.externalAccess.service.loadBalancerIP[4]=rc4.52.78.167.68.nip.io \
    --set cluster.externalAccess.service.loadBalancerIP[5]=rc5.52.78.167.68.nip.io \
    --dry-run=true

    
    ### 추가옵션 ###
    ### 아래와 같이 설정되면 svc 명으로 redirect 됨
    --set cluster.externalAccess.service.loadBalancerIP[0]=ds-redis-redis-cluster-0-svc \
    --set cluster.externalAccess.service.loadBalancerIP[1]=ds-redis-redis-cluster-1-svc \
    --set cluster.externalAccess.service.loadBalancerIP[2]=ds-redis-redis-cluster-2-svc \
    --set cluster.externalAccess.service.loadBalancerIP[3]=ds-redis-redis-cluster-3-svc \
    --set cluster.externalAccess.service.loadBalancerIP[4]=ds-redis-redis-cluster-4-svc \
    --set cluster.externalAccess.service.loadBalancerIP[5]=ds-redis-redis-cluster-5-svc \

##
W0221 22:14:49.166632  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-5-svc"): unable to parse IP
W0221 22:14:49.230392  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-2-svc"): unable to parse IP
W0221 22:14:49.363272  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-1-svc"): unable to parse IP
W0221 22:14:49.479519  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-0-svc"): unable to parse IP
W0221 22:14:49.660636  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-4-svc"): unable to parse IP
W0221 22:14:49.663597  476527 warnings.go:70] spec.loadBalancerIP: IP address was accepted, but will be invalid in a future Kubernetes release: ParseAddr("ds-redis-redis-cluster-3-svc"): unable to parse IP
NAME: ds-redis
LAST DEPLOYED: Wed Feb 21 22:14:47 2024
NAMESPACE: redis-cluster
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: redis-cluster
CHART VERSION: 9.5.2
APP VERSION: 7.2.4** Please be patient while the chart is being deployed **


To get your password run:
    export REDIS_PASSWORD=$(kubectl get secret --namespace "redis-cluster" ds-redis-redis-cluster -o jsonpath="{.data.redis-password}" | base64 -d)

To connect to your Redis&reg; server from outside the cluster check the following information:

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: 'kubectl get svc --namespace redis-cluster -w ds-redis-redis-cluster'

    You will have a different external IP for each Redis&reg; node. Get the external ip from `-external` suffixed services: `kubectl get svc`.
    Redis&reg; port: 6379INFO: The Job to create the cluster will be created.To connect to your database from outside the cluster execute the following commands:

    export SERVICE_IP=$(kubectl get svc --namespace redis-cluster ds-redis-redis-cluster-0-svc --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
    redis-cli -c -h $SERVICE_IP -p 6379 -a $REDIS_PASSWORD
    
    
    
    
    
##
NAME: ds-redis
LAST DEPLOYED: Sun Jul  9 06:00:01 2023
NAMESPACE: redis-cluster
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: redis-cluster
CHART VERSION: 8.6.6
APP VERSION: 7.0.11** Please be patient while the chart is being deployed **


To get your password run:
    export REDIS_PASSWORD=$(kubectl get secret --namespace "redis-cluster" ds-redis-redis-cluster -o jsonpath="{.data.redis-password}" | base64 -d)

You have deployed a Redis&reg; Cluster accessible only from within you Kubernetes Cluster.INFO: The Job to create the cluster will be created.To connect to your Redis&reg; cluster:

1. Run a Redis&reg; pod that you can use as a client:
kubectl run --namespace redis-cluster ds-redis-redis-cluster-client --rm --tty -i --restart='Never' \
 --env REDIS_PASSWORD=$REDIS_PASSWORD \
--image docker.io/bitnami/redis-cluster:7.0.11-debian-11-r27 -- bash

2. Connect using the Redis&reg; CLI:

redis-cli -c -h ds-redis-redis-cluster -a $REDIS_PASSWORD




# 설치목록 확인
$ helm -n redis-cluster ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ds-redis      redis-cluster    1               2023-07-09 06:00:01.635466263 +0000 UTC deployed        redis-cluster-8.6.6     7.0.11

NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ds-redis      redis-cluster    1               2024-02-21 22:14:47.846882898 +0900 KST deployed        redis-cluster-9.5.2     7.2.4


NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ds-redis        redis-cluster   1               2024-03-11 15:21:58.662777665 +0000 UTC deployed        redis-cluster-9.8.0     7.2.4




# 확인
$ helm -n redis-cluster status ds-redis
$ helm -n redis-cluster get all ds-redis



# 삭제 
$ helm -n redis-cluster delete ds-redis


```



### (2) pod / svc 확인

```sh
$ kubectl -n redis-cluster get pod

NAME                         READY   STATUS    RESTARTS   AGE
ds-redis-redis-cluster-0   2/2     Running   0          81s
ds-redis-redis-cluster-1   2/2     Running   0          81s
ds-redis-redis-cluster-2   2/2     Running   0          81s
ds-redis-redis-cluster-3   2/2     Running   0          81s
ds-redis-redis-cluster-4   2/2     Running   0          81s
ds-redis-redis-cluster-5   2/2     Running   0          81s



# 약 1분 정도 소요됨 

$ kubectl -n redis-cluster get svc
NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
ds-redis-redis-cluster            ClusterIP      10.43.5.128     <none>        6379/TCP                         87s
ds-redis-redis-cluster-0-svc      LoadBalancer   10.43.147.46    172.30.1.88   6379:32121/TCP,16379:32004/TCP   87s
ds-redis-redis-cluster-1-svc      LoadBalancer   10.43.216.237   <pending>     6379:30803/TCP,16379:31221/TCP   87s
ds-redis-redis-cluster-2-svc      LoadBalancer   10.43.192.114   <pending>     6379:30155/TCP,16379:30273/TCP   87s
ds-redis-redis-cluster-3-svc      LoadBalancer   10.43.48.152    <pending>     6379:32083/TCP,16379:31813/TCP   87s
ds-redis-redis-cluster-4-svc      LoadBalancer   10.43.171.133   <pending>     6379:32473/TCP,16379:31025/TCP   87s
ds-redis-redis-cluster-5-svc      LoadBalancer   10.43.29.98     <pending>     6379:31718/TCP,16379:30969/TCP   87s
ds-redis-redis-cluster-headless   ClusterIP      None            <none>        6379/TCP,16379/TCP               87s



NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
ds-redis-redis-cluster            ClusterIP      10.43.43.29     <none>        6379/TCP                         2m4s
ds-redis-redis-cluster-0-svc      LoadBalancer   10.43.161.60    <pending>     6379:31350/TCP,16379:30592/TCP   2m4s
ds-redis-redis-cluster-1-svc      LoadBalancer   10.43.237.54    <pending>     6379:31848/TCP,16379:32329/TCP   2m4s
ds-redis-redis-cluster-2-svc      LoadBalancer   10.43.235.129   172.30.1.31   6379:31989/TCP,16379:30029/TCP   2m4s
ds-redis-redis-cluster-3-svc      LoadBalancer   10.43.60.1      <pending>     6379:32179/TCP,16379:32743/TCP   2m4s
ds-redis-redis-cluster-4-svc      LoadBalancer   10.43.86.222    <pending>     6379:32066/TCP,16379:32164/TCP   2m4s
ds-redis-redis-cluster-5-svc      LoadBalancer   10.43.98.177    172.30.1.32   6379:32004/TCP,16379:32563/TCP   2m4s
ds-redis-redis-cluster-headless   ClusterIP      None            <none>        6379/TCP,16379/TCP               2m4s


```





### (3) Internal Access

redis client를 cluster 내부에서 실행후 접근하는 방법을 알아보자.



#### Redis client 실행

먼저 아래와 같이 동일한 Namespace 에 redis-client 를 실행한다.

```sh
## redis-client 용도로 deployment 를 실행한다.
$ kubectl -n redis-cluster create deploy redis-client \
    --image=docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3 \
    -- sleep 365d
    
deployment.apps/redis-client created


## redis client pod 확인
$ kubectl -n redis-cluster get pod
NAME                            READY   STATUS    RESTARTS   AGE
redis-client-69dcc9c76d-rgtgx   1/1     Running   0          8s

# 약 10초 정도 소요된다.


## redis-client 로 접근한다.
## okd web console 에서 해당 pod 의 terminal 로 접근해도 된다.
$ kubectl -n redis-cluster exec -it deploy/redis-client -- bash

I have no name!@redis-client-69dcc9c76d-rgtgx:/$    # <-- 이런 Prompt 가 나오면 정상

```



#### Redis Info

```sh
## redis-client pod 내부에서...

 
$ redis-cli -h ds-redis-redis-cluster -c -a new1234




# 특정 node로 접근할때
$ redis-cli -h ds-redis-redis-cluster-0-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-1-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-2-svc -c -a new1234
....
$ redis-cli -h ds-redis-redis-cluster-4-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-5-svc -c -a new1234


## cluster node 를 확인
ds-redis-redis-cluster:6379> cluster nodes
cd6820769a5b3d75a1dd5e9739eb264fb6f60ab1 ds-redis-redis-cluster-2-svc:6379@16379 master - 0 1688907353531 3 connected 10923-16383
5953f810b2bf73c283c393c4ee9f725775759af3 ds-redis-redis-cluster-5-svc:6379@16379 myself,slave fbdec1c82805e36da85530f0451a7ebcc63ac458 0 1688907353000 2 connected
fbdec1c82805e36da85530f0451a7ebcc63ac458 ds-redis-redis-cluster-1-svc:6379@16379 master - 0 1688907353000 2 connected 5461-10922
1de28c8c3436e9b8f42a6a80382fcdc4903a97e3 ds-redis-redis-cluster-3-svc:6379@16379 slave cd6820769a5b3d75a1dd5e9739eb264fb6f60ab1 0 1688907354545 3 connected
63d3744de13f2898137d4b90c55cc3639cfebe49 ds-redis-redis-cluster-0-svc:6379@16379 master - 0 1688907354000 1 connected 0-5460
8fd49b4fb17c743a7f666e6a30b659fa39ecf73c ds-redis-redis-cluster-4-svc:6379@16379 slave 63d3744de13f2898137d4b90c55cc3639cfebe49 0 1688907351515 1 connected

## master 3개, slave가 3개 사용하는 모습을 볼 수가 있다.


## cluster info 확인
ds-redis-redis-cluster:6379> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:2
cluster_stats_messages_ping_sent:2918
cluster_stats_messages_pong_sent:2926
cluster_stats_messages_meet_sent:1
cluster_stats_messages_sent:5845
cluster_stats_messages_ping_received:2926
cluster_stats_messages_pong_received:2919
cluster_stats_messages_received:5845
total_cluster_links_buffer_limit_exceeded:0

## cluster state 가 OK 인 것을 확인할 수 있다.
```



#### set / get 확인

```sh
## redis-client pod 내부에서...

ds-redis-redis-cluster:6379> set a 1
-> Redirected to slot [15495] located at ds-redis-redis-cluster-2-svc:6379
OK
ds-redis-redis-cluster-2-svc:6379>
ds-redis-redis-cluster-2-svc:6379>
ds-redis-redis-cluster-2-svc:6379> set b 2
-> Redirected to slot [3300] located at ds-redis-redis-cluster-0-svc:6379
OK
ds-redis-redis-cluster-0-svc:6379>
ds-redis-redis-cluster-0-svc:6379> set c 3
-> Redirected to slot [7365] located at ds-redis-redis-cluster-1-svc:6379
OK
ds-redis-redis-cluster-1-svc:6379>
ds-redis-redis-cluster-1-svc:6379> get a
-> Redirected to slot [15495] located at ds-redis-redis-cluster-2-svc:6379
"1"
ds-redis-redis-cluster-2-svc:6379> get b
-> Redirected to slot [3300] located at ds-redis-redis-cluster-0-svc:6379
"2"
ds-redis-redis-cluster-0-svc:6379> get c
-> Redirected to slot [7365] located at ds-redis-redis-cluster-1-svc:6379
"3"
ds-redis-redis-cluster-1-svc:6379>




# 테스트 완료시
# Ctrl+D,   Ctrl+D 로   Exit 하자.
```









## 3) helm install - IPC



### (1) Namespace 셋팅



```yaml

apiVersion: v1
kind: Namespace
metadata:
  annotations:
    openshift.io/description: ""
    openshift.io/display-name: ""
    openshift.io/node-selector: sa=true,redis-cluster=true
    openshift.io/requester: admin
    openshift.io/sa.scc.mcs: s0:c26,c25
    openshift.io/sa.scc.supplemental-groups: 1000700000/10000
    openshift.io/sa.scc.uid-range: 1000700000/10000
  labels:
    kubernetes.io/metadata.name: redis-cluster
  name: redis-poc
spec:
  finalizers:
  - kubernetes

```









### (2) Image 등 준비

```sh


# 1) image version

nexus.dspace.kt.co.kr/bitnami/redis:6.2.6-debian-10-r169

nexus.dspace.kt.co.kr/icis/redis-cluster:7.0.9-debian-11-r1    <-- 이걸 그냥 사용하자.



# 2) redis-cluster 의 ingress 주소

rc0.sit.icis.kt.co.kr
rc1.sit.icis.kt.co.kr
rc2.sit.icis.kt.co.kr
rc3.sit.icis.kt.co.kr
rc3.sit.icis.kt.co.kr
rc5.sit.icis.kt.co.kr


# 3) sa 권한
oc adm policy add-scc-to-user anyuid -z sa-redis-redis-cluster -n redis-poc
oc adm policy add-scc-to-user anyuid -z default                -n redis-poc

oc adm policy add-scc-to-user privileged -z sa-redis-redis-cluster -n redis-poc
oc adm policy add-scc-to-user privileged -z default                -n redis-poc



```





#### image pull 권한



```yaml
kind: Secret
apiVersion: v1
metadata:
  name: dspace-nexus
  namespace: redis-poc
  uid: d0370444-7ee1-4697-aa78-3a53e82aa78c
data:
  .dockerconfigjson: >-
    eyJhdXRocyI6eyJuZXh1cy5kc3BhY2Uua3QuY28ua3IiOnsidXNlcm5hbWUiOiJpY2lzdHItc2EiLCJwYXNzd29yZCI6ImljaXN0ci1zYSIsImVtYWlsIjoiaWNpc3RyLXNhQGt0LmNvLmtyIiwiYXV0aCI6ImFXTnBjM1J5TFhOaE9tbGphWE4wY2kxellRPT0ifX19
type: kubernetes.io/dockerconfigjson


```



#### 

```yaml
kind: ServiceAccount
apiVersion: v1
metadata:
  name: default
  namespace: redis-poc
secrets:
  - name: default-dockercfg-v276z
  - name: default-token-x88r9
imagePullSecrets:
  - name: dspace-nexus
  - name: default-dockercfg-v276z
```







### (2) helm install



```sh
# helm install
# master 2, slave 3 실행


#$ helm -n redis-poc install ds-redis bitnami/redis-cluster \
#    --set password=new1234 \
#    ...


# dry-run
$ helm -n redis-poc install sa-redis . \
    --set password=new1234 \
    --set persistence.enabled=false \
    --set metrics.enabled=false \
    --set image.registry=nexus.dspace.kt.co.kr \
    --set image.repository=icis/redis-cluster \
    --set image.tag=7.0.9-debian-11-r1 \
    --set cluster.nodes=6 \
    --set cluster.replicas=1 \
    --set cluster.externalAccess.enabled=true \
    --set cluster.externalAccess.service.type=LoadBalancer \
    --set cluster.externalAccess.service.loadBalancerIP[0]=rc0.sit.icis.kt.co.kr \
    --set cluster.externalAccess.service.loadBalancerIP[1]=rc1.sit.icis.kt.co.kr \
    --set cluster.externalAccess.service.loadBalancerIP[2]=rc2.sit.icis.kt.co.kr \
    --set cluster.externalAccess.service.loadBalancerIP[3]=rc3.sit.icis.kt.co.kr \
    --set cluster.externalAccess.service.loadBalancerIP[4]=rc4.sit.icis.kt.co.kr \
    --set cluster.externalAccess.service.loadBalancerIP[5]=rc5.sit.icis.kt.co.kr \
    --dry-run=true
    
    
    ### 추가옵션 ###
    ### 아래와 같이 설정되면 svc 명으로 redirect 됨
    --set cluster.externalAccess.service.loadBalancerIP[0]=ds-redis-redis-cluster-0-svc \
    --set cluster.externalAccess.service.loadBalancerIP[1]=ds-redis-redis-cluster-1-svc \
    --set cluster.externalAccess.service.loadBalancerIP[2]=ds-redis-redis-cluster-2-svc \
    --set cluster.externalAccess.service.loadBalancerIP[3]=ds-redis-redis-cluster-3-svc \
    --set cluster.externalAccess.service.loadBalancerIP[4]=ds-redis-redis-cluster-4-svc \
    --set cluster.externalAccess.service.loadBalancerIP[5]=ds-redis-redis-cluster-5-svc \

##
NAME: sa-redis
LAST DEPLOYED: Thu Feb 22 14:39:33 2024
NAMESPACE: redis-poc
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: redis-cluster
CHART VERSION: 9.5.2
APP VERSION: 7.2.4** Please be patient while the chart is being deployed **


To get your password run:
    export REDIS_PASSWORD=$(kubectl get secret --namespace "redis-poc" sa-redis-redis-cluster -o jsonpath="{.data.redis-password}" | base64 -d)

To connect to your Redis&reg; server from outside the cluster check the following information:

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: 'kubectl get svc --namespace redis-poc -w sa-redis-redis-cluster'

    You will have a different external IP for each Redis&reg; node. Get the external ip from `-external` suffixed services: `kubectl get svc`.
    Redis&reg; port: 6379INFO: The Job to create the cluster will be created.To connect to your database from outside the cluster execute the following commands:

    export SERVICE_IP=$(kubectl get svc --namespace redis-poc sa-redis-redis-cluster-0-svc --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
    redis-cli -c -h $SERVICE_IP -p 6379 -a $REDIS_PASSWORD





# 설치목록 확인
$ helm -n redis-poc ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ds-redis      redis-cluster    1               2023-07-09 06:00:01.635466263 +0000 UTC deployed        redis-cluster-8.6.6     7.0.11

NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ds-redis      redis-cluster    1               2024-02-21 22:14:47.846882898 +0900 KST deployed        redis-cluster-9.5.2     7.2.4

NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
sa-redis        redis-poc       1               2024-02-22 14:39:33.7269602 +0900 KST   deployed        redis-cluster-9.5.2     7.2.4



# 확인
$ helm -n redis-poc status ds-redis
$ helm -n redis-poc get all ds-redis



# 삭제시...
$ helm -n redis-poc delete ds-redis
```



### (3) pod / svc 확인

```sh
$ kubectl -n redis-poc get pod
NAME                       READY   STATUS    RESTARTS   AGE
sa-redis-redis-cluster-0   1/1     Running   0          2m29s
sa-redis-redis-cluster-1   1/1     Running   0          45s
sa-redis-redis-cluster-2   1/1     Running   0          44s
sa-redis-redis-cluster-3   1/1     Running   0          43s
sa-redis-redis-cluster-4   1/1     Running   0          42s
sa-redis-redis-cluster-5   1/1     Running   0          41s



# 약 1분 정도 소요됨 

$ kubectl -n redis-poc get svc

NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
ds-redis-redis-cluster            ClusterIP      10.43.5.128     <none>        6379/TCP                         87s
ds-redis-redis-cluster-0-svc      LoadBalancer   10.43.147.46    172.30.1.88   6379:32121/TCP,16379:32004/TCP   87s
ds-redis-redis-cluster-1-svc      LoadBalancer   10.43.216.237   <pending>     6379:30803/TCP,16379:31221/TCP   87s
ds-redis-redis-cluster-2-svc      LoadBalancer   10.43.192.114   <pending>     6379:30155/TCP,16379:30273/TCP   87s
ds-redis-redis-cluster-3-svc      LoadBalancer   10.43.48.152    <pending>     6379:32083/TCP,16379:31813/TCP   87s
ds-redis-redis-cluster-4-svc      LoadBalancer   10.43.171.133   <pending>     6379:32473/TCP,16379:31025/TCP   87s
ds-redis-redis-cluster-5-svc      LoadBalancer   10.43.29.98     <pending>     6379:31718/TCP,16379:30969/TCP   87s
ds-redis-redis-cluster-headless   ClusterIP      None            <none>        6379/TCP,16379/TCP               87s

NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
ds-redis-redis-cluster            ClusterIP      10.43.43.29     <none>        6379/TCP                         2m4s
ds-redis-redis-cluster-0-svc      LoadBalancer   10.43.161.60    <pending>     6379:31350/TCP,16379:30592/TCP   2m4s
ds-redis-redis-cluster-1-svc      LoadBalancer   10.43.237.54    <pending>     6379:31848/TCP,16379:32329/TCP   2m4s
ds-redis-redis-cluster-2-svc      LoadBalancer   10.43.235.129   172.30.1.31   6379:31989/TCP,16379:30029/TCP   2m4s
ds-redis-redis-cluster-3-svc      LoadBalancer   10.43.60.1      <pending>     6379:32179/TCP,16379:32743/TCP   2m4s
ds-redis-redis-cluster-4-svc      LoadBalancer   10.43.86.222    <pending>     6379:32066/TCP,16379:32164/TCP   2m4s
ds-redis-redis-cluster-5-svc      LoadBalancer   10.43.98.177    172.30.1.32   6379:32004/TCP,16379:32563/TCP   2m4s
ds-redis-redis-cluster-headless   ClusterIP      None            <none>        6379/TCP,16379/TCP               2m4s


NAME                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE
sa-redis-redis-cluster            ClusterIP      172.30.175.187   <none>        6379/TCP                         17m
sa-redis-redis-cluster-0-svc      LoadBalancer   172.30.153.73    <pending>     6379:31040/TCP,16379:30104/TCP   17m
sa-redis-redis-cluster-1-svc      LoadBalancer   172.30.226.129   <pending>     6379:31755/TCP,16379:32463/TCP   17m
sa-redis-redis-cluster-2-svc      LoadBalancer   172.30.80.187    <pending>     6379:31522/TCP,16379:30835/TCP   17m
sa-redis-redis-cluster-3-svc      LoadBalancer   172.30.199.194   <pending>     6379:31859/TCP,16379:32168/TCP   17m
sa-redis-redis-cluster-4-svc      LoadBalancer   172.30.81.177    <pending>     6379:32238/TCP,16379:30921/TCP   17m
sa-redis-redis-cluster-5-svc      LoadBalancer   172.30.85.163    <pending>     6379:32167/TCP,16379:31949/TCP   17m
sa-redis-redis-cluster-headless   ClusterIP      None             <none>        6379/TCP,16379/TCP               17m



```





### (4) Internal Access

redis client를 cluster 내부에서 실행후 접근하는 방법을 알아보자.



#### Redis client 실행

먼저 아래와 같이 동일한 Namespace 에 redis-client 를 실행한다.

```sh
## redis-client 용도로 deployment 를 실행한다.
$ kubectl -n redis-cluster create deploy redis-client \
    --image=docker.io/bitnami/redis-cluster:6.2.7-debian-11-r3 \
    -- sleep 365d

$ kubectl -n redis-cluster create deploy redis-client \
    --image=docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3 \
    -- sleep 365d

$ kubectl -n redis-poc create deploy redis-client \
    --image=nexus.dspace.kt.co.kr/bitnami/redis:6.2.6-debian-10-r169 \
    -- sleep 365d





deployment.apps/redis-client created


## redis client pod 확인
$ kubectl -n redis-poc get pod
NAME                            READY   STATUS    RESTARTS   AGE
redis-client-69dcc9c76d-rgtgx   1/1     Running   0          8s

# 약 10초 정도 소요된다.


## redis-client 로 접근한다.
## okd web console 에서 해당 pod 의 terminal 로 접근해도 된다.
$ kubectl -n redis-poc exec -it deploy/redis-client -- bash
I have no name!@redis-client-69dcc9c76d-rgtgx:/$    # <-- 이런 Prompt 가 나오면 정상

```



#### Redis Info

```sh
## redis-client pod 내부에서...

 
$ redis-cli -h sa-redis-redis-cluster -c -a new1234




# 특정 node로 접근할때
$ redis-cli -h ds-redis-redis-cluster-0-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-1-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-2-svc -c -a new1234
....
$ redis-cli -h ds-redis-redis-cluster-4-svc -c -a new1234
$ redis-cli -h ds-redis-redis-cluster-5-svc -c -a new1234


## cluster node 를 확인
ds-redis-redis-cluster:6379> cluster nodes
cd6820769a5b3d75a1dd5e9739eb264fb6f60ab1 ds-redis-redis-cluster-2-svc:6379@16379 master - 0 1688907353531 3 connected 10923-16383
5953f810b2bf73c283c393c4ee9f725775759af3 ds-redis-redis-cluster-5-svc:6379@16379 myself,slave fbdec1c82805e36da85530f0451a7ebcc63ac458 0 1688907353000 2 connected
fbdec1c82805e36da85530f0451a7ebcc63ac458 ds-redis-redis-cluster-1-svc:6379@16379 master - 0 1688907353000 2 connected 5461-10922
1de28c8c3436e9b8f42a6a80382fcdc4903a97e3 ds-redis-redis-cluster-3-svc:6379@16379 slave cd6820769a5b3d75a1dd5e9739eb264fb6f60ab1 0 1688907354545 3 connected
63d3744de13f2898137d4b90c55cc3639cfebe49 ds-redis-redis-cluster-0-svc:6379@16379 master - 0 1688907354000 1 connected 0-5460
8fd49b4fb17c743a7f666e6a30b659fa39ecf73c ds-redis-redis-cluster-4-svc:6379@16379 slave 63d3744de13f2898137d4b90c55cc3639cfebe49 0 1688907351515 1 connected

## master 3개, slave가 3개 사용하는 모습을 볼 수가 있다.


## cluster info 확인
ds-redis-redis-cluster:6379> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:2
cluster_stats_messages_ping_sent:2918
cluster_stats_messages_pong_sent:2926
cluster_stats_messages_meet_sent:1
cluster_stats_messages_sent:5845
cluster_stats_messages_ping_received:2926
cluster_stats_messages_pong_received:2919
cluster_stats_messages_received:5845
total_cluster_links_buffer_limit_exceeded:0

## cluster state 가 OK 인 것을 확인할 수 있다.
```



#### 실패 사례

```sh

sa-redis-redis-cluster:6379> cluster info
cluster_state:fail
cluster_slots_assigned:0
cluster_slots_ok:0
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:1
cluster_size:0
cluster_current_epoch:0
cluster_my_epoch:0
cluster_stats_messages_sent:0
cluster_stats_messages_received:0
total_cluster_links_buffer_limit_exceeded:0



sa-redis-redis-cluster:6379> cluster nodes
f191c6c13a8d9e46fb1361ba6826322def070047 rc0.sit.icis.kt.co.kr:6379@16379 myself,master - 0 0 0 connected


```



#### 0번 pod log

```
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
Could not connect to Redis at rc0.sit.icis.kt.co.kr:6379: Connection refused
Node rc0.sit.icis.kt.co.kr not ready, waiting for all the nodes to be ready...
```

rc0.sit.icis.kt.co.kr:6379 를 읽을 수 없어서 발생하는 이슈이다.











#### set / get 확인

```sh
## redis-client pod 내부에서...

ds-redis-redis-cluster:6379> set a 1
-> Redirected to slot [15495] located at ds-redis-redis-cluster-2-svc:6379
OK
ds-redis-redis-cluster-2-svc:6379>
ds-redis-redis-cluster-2-svc:6379>
ds-redis-redis-cluster-2-svc:6379> set b 2
-> Redirected to slot [3300] located at ds-redis-redis-cluster-0-svc:6379
OK
ds-redis-redis-cluster-0-svc:6379>
ds-redis-redis-cluster-0-svc:6379> set c 3
-> Redirected to slot [7365] located at ds-redis-redis-cluster-1-svc:6379
OK
ds-redis-redis-cluster-1-svc:6379>
ds-redis-redis-cluster-1-svc:6379> get a
-> Redirected to slot [15495] located at ds-redis-redis-cluster-2-svc:6379
"1"
ds-redis-redis-cluster-2-svc:6379> get b
-> Redirected to slot [3300] located at ds-redis-redis-cluster-0-svc:6379
"2"
ds-redis-redis-cluster-0-svc:6379> get c
-> Redirected to slot [7365] located at ds-redis-redis-cluster-1-svc:6379
"3"
ds-redis-redis-cluster-1-svc:6379>




# 테스트 완료시
# Ctrl+D,   Ctrl+D 로   Exit 하자.
```







## 4) docker client



```sh


$ docker pull docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3

$ docker run -d --name redis-client \
    docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3 \
    sleep 365d


$ docker exec -it redis-client bash




# 
$ redis-cli -h redis.172.30.1.31.nip.io -p 31379 -c -a new1234








```





## 9) Clean Up

```sh


# 1) Redis 확인
$ helm -n redis-cluster delete ds-redis

# 2) Redis 삭제
$ helm -n redis-cluster delete ds-redis

# 3) redis-client 삭제
$ kubectl -n redis-cluster delete deploy/redis-client

# 4) namespace 삭제
$ kubectl delete namespace redis-cluster


# 확인
$ helm -n redis-cluster ls
$ kubectl -n redis-cluster get all
```







# 3. nginx ingress controller 설치



https://velog.io/@yange/Ingress%EC%97%90-%EB%8C%80%ED%95%B4%EC%84%9C-nginx-ingress-controller



https://kubernetes.github.io/ingress-nginx/



## 1) helm nginx install



### (1) value.yaml 확인



```sh

$ helm show values ingress-nginx --repo https://kubernetes.github.io/ingress-nginx

## nginx configuration
## Ref: https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/index.md
##
...

```



### (2) helm install

```SH

$ helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace



NAME: ingress-nginx
LAST DEPLOYED: Wed Feb 21 22:33:10 2024
NAMESPACE: ingress-nginx
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
The ingress-nginx controller has been installed.
It may take a few minutes for the load balancer IP to be available.
You can watch the status by running 'kubectl get service --namespace ingress-nginx ingress-nginx-controller --output wide --watch'

An example Ingress that makes use of the controller:
  apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    name: example
    namespace: foo
  spec:
    ingressClassName: nginx
    rules:
      - host: www.example.com
        http:
          paths:
            - pathType: Prefix
              backend:
                service:
                  name: exampleService
                  port:
                    number: 80
              path: /
    # This section is only required if TLS is to be enabled for the Ingress
    tls:
      - hosts:
        - www.example.com
        secretName: example-tls

If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:

  apiVersion: v1
  kind: Secret
  metadata:
    name: example-tls
    namespace: foo
  data:
    tls.crt: <base64 encoded cert>
    tls.key: <base64 encoded key>
  type: kubernetes.io/tls






```





## 2) ingress test



```sh



$ kubectl -n ingress-nginx create deployment demo --image=httpd --port=80

$ kubectl -n ingress-nginx expose deployment demo

$ kubectl -n ingress-nginx create ingress demo-localhost --class=nginx \
    --rule="demo.localdev.me/*=demo:80"


$ curl 172.30.1.31:32159 -i -H "Host:demo.localdev.me"

$ curl 172.31.9.223:32159 -i -H "Host:demo.localdev.me"



HTTP/1.1 200 OK

<-- 오 잘된다.


```





### ingress 확인

```yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: "2024-02-21T14:50:04Z"
  generation: 1
  name: demo-localhost
  namespace: redis-cluster
  resourceVersion: "68275098"
  uid: 73d31175-ba61-4b5b-ba6b-029ad343c9c9
spec:
  ingressClassName: nginx
  rules:
  - host: demo.localdev.me
    http:
      paths:
      - backend:
          service:
            name: demo
            port:
              number: 80
        path: /
        pathType: Prefix


```







# 4. redis 연결을 위한 ingress tcp 설정



https://codecollector.tistory.com/1465



### (1) configmap 생성



```sh

apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-tcp-services
  namespace: ingress-nginx
data:
  6379: "{namespace명}/{redis cluster가 외부노출된 service명}:{연결할 port번호}" => 예시

  
  
$ cd ~/temp/ingress-nginx

$ cat > 21.redis-tcp-service-config.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-tcp-services
  namespace: ingress-nginx
data:
  6379: "redis-cluster/ds-redis-redis-cluster:6379"
---


$ kubectl -n ingress-nginx apply -f 21.redis-tcp-service-config.yaml
configmap/redis-tcp-services created




```







### (2) deployment



```sh


$ kubectl get deploy -n ingress-nginx
NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
ingress-nginx-controller   1/1     1            1           16m


$ kubectl edit deploy ingress-nginx-controller -n ingress-nginx



    spec:
      containers:
      - args:
        - /nginx-ingress-controller
        - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller
        - --election-id=ingress-nginx-leader
        - --controller-class=k8s.io/ingress-nginx
        - --ingress-class=nginx
        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
        - --validating-webhook=:8443
        - --validating-webhook-certificate=/usr/local/certificates/cert
        - --validating-webhook-key=/usr/local/certificates/key
        - --tcp-services-configmap=ingress-nginx/redis-tcp-services              <--- 추가
        env:
        
        
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          name: https
          protocol: TCP
        - containerPort: 8443
          name: webhook
          protocol: TCP
                               <-- 아래 추가
        - containerPort: 6379
          hostPort: 6379
          name: redisport
          protocol: TCP

        


```











### (3) service 수정



```sh


  - appProtocol: https
    name: {외부로 노출한 redis cluster service명}
    port: {ingress controller service가 사용할 container port}
    protocol: TCP
    targetPort: {ingress controller service가 routing할 목적지 container port}
    

$ kubectl get svc -n ingress-nginx

$ kubectl edit svc ingress-nginx-controller -n ingress-nginx


  ports:
  - appProtocol: http
    name: http
    nodePort: 30969
    port: 80
    protocol: TCP
    targetPort: http
  - appProtocol: https
    name: https
    nodePort: 32066
    port: 443
    protocol: TCP
    targetPort: https
                               <-- 아래 추가
  - appProtocol: https
    name: redis-cluster
    nodePort: 32637
    port: 6379
    protocol: TCP
    targetPort: 6379


                
$ kubectl get svc -n ingress-nginx
NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                     AGE
ingress-nginx-controller LoadBalancer   10.43.43.122    <pending>     80:32159/TCP,443:31843/TCP,7777:31475/TCP   24m



```



### (4) pod 재기동







### (5) docker 에서 redis 연결테스트

```sh


$ docker pull docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3

$ docker run -d --name redis-client \
    docker.io/bitnami/redis-cluster:7.2.4-debian-11-r3 \
    sleep 365d


$ docker exec -it redis-client bash


# < Service 로 접근 테스트 >

# node ID   : 172.31.9.223
# 공인IP     : 52.78.167.68
# node port : 31475

# 1) 내부 IP 로 접근
$ redis-cli -h 172.31.9.223 -a new1234 -c -p 31475
# 성공


# 2) 공인 IP 로 접근
$ redis-cli -h 52.78.167.68 -a new1234 -c -p 31475
# 처음만 성공
# redirect 되면 안됨


# 3) 7777
$ redis-cli -h 10.43.43.122 -a new1234 -c -p 7777
Could not connect to Redis at 172.31.9.223:7777: Connection refused
# 서비스 주소도 오 성공


# 3) 7777
$ redis-cli -h 172.31.9.223 -a new1234 -c -p 6379



# < pod(hostport) 로 접근 테스트 >

# node ID   : 172.31.9.223
# 공인IP     : 52.78.167.68
# node port : 6379


$ redis-cli -h 172.31.9.223 -a new1234 -c -p 6379
# 성공

$ redis-cli -h 52.78.167.68 -a new1234 -c -p 6379
# 첫번째만성공



```



## 결론

* Nginx 를 통해서 tcp 유입은 가능하지만 port 당 하나의 서비스를 매핑하는 구조이다.
* 하지만 redis cluster 의 경우 동일한 port 를 사용하는 6개의 서비스가 존재하는 구조이다.
* 현재의 Nginx 는 hostname 기반  TCP라우팅이 지원되지 않는다.
* 그러므로 이 방법으로는 사용할 수 없다.
* 







### [참고] redis host 확인

```sh
# internal 접근을 위한 host 확인
# nc 명령으로 접근가능여부를 확인할 수 있다.

$ apt update
  apt install netcat-openbsd

$ nc -zv 10.42.0.30 6379


Connection to 43.203.62.69 32300 port [tcp/*] succeeded!


```















## 9) Clean Up

```sh

# 확인
$ helm -n ingress-nginx ls

# 삭제
$ helm -n ingress-nginx delete ingress-nginx


```













# 4. traefik ingress controller 설정

## 1) yaml 확인

* deployment

```yaml

apiVersion: apps/v1
kind: Deployment
...
  name: traefik
  namespace: kube-system
...
    spec:
      containers:
...
        name: traefik
        ports:
        - containerPort: 9100
          name: metrics
          protocol: TCP
        - containerPort: 9000
          name: traefik
          protocol: TCP
        - containerPort: 8000
          name: web
          protocol: TCP
        - containerPort: 8443
          name: websecure
          protocol: TCP

```



* service

```yaml

apiVersion: v1
kind: Service
metadata:
...
  name: traefik
  namespace: kube-system

...
spec:
  allocateLoadBalancerNodePorts: true
...
  ports:
  - name: web
    nodePort: 31919
    port: 80
    protocol: TCP
    targetPort: web
  - name: websecure
    nodePort: 31352
    port: 443
    protocol: TCP
    targetPort: websecure
  - name: tcp
    nodePort: 31379        <--  추가
    port: 6379
    protocol: TCP
    targetPort: traefik
...
  type: LoadBalancer


```





## 2) userlist ingress



```

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  labels:
    app.kubernetes.io/instance: userlist
  name: userlist-ingress
  namespace: yjsong
spec:
  ingressClassName: traefik
  rules:
  - host: userlist.ssongman.duckdns.org
    http:
      paths:
      - backend:
          service:
            name: userlist-svc
            port:
              number: 80
        path: /
        pathType: Prefix

```







```sh

$ curl userlist.ssongman.duckdns.org/users/1

$ curl 172.30.1.31:31919/users/1 -H "Host:userlist.ssongman.duckdns.org"

$ curl 172.30.1.31:31379/users/1 -H "Host:userlist.ssongman.duckdns.org"

```



## 3) redis ingress



```
$ cat > 15.redis-ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  labels:
    app.kubernetes.io/instance: userlist
  name: redis-ingress
  namespace: redis-cluster
spec:
  ingressClassName: traefik
  rules:
  - host: redis.172.30.1.31.nip.io
    http:
      paths:
      - backend:
          service:
            name: ds-redis-redis-cluster
            port:
              number: 6379
        path: /
        pathType: Prefix

```





```
$ cat > 15.redis-ingress.yaml


apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    ingress.citrix.com/insecure-port: "6379"
    ingress.citrix.com/insecure-service-type: "tcp"
  name: redis-ingress
  namespace: redis-cluster
spec:
  defaultBackend:
    service:
      name: ds-redis-redis-cluster
      port:
        number: 6379
```







```sh



$ redis redis.172.30.1.31.nip.io:31379/users/1 -H "Host:userlist.ssongman.duckdns.org"


```





```yaml



apiVersion: traefik.io/v1alpha1
kind: IngressRouteTCP
metadata:
  name: ingressroute.tcp
  namespace: default

spec:
  entryPoints:
    - tcpep
  routes:
  - match: HostSNI(`bar`)
    services:
      - name: whoamitcp
        port: 8080




```

