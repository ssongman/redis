#  1. Redis-Cluster Hostport



externalAccess 에서 접근가능하도록 worker node IP 를 직접 설정한다.

하지만 해당 worker node 에 해당 pod 가 직접 수행되지 않아서 오류가 발생할 것이다. 그러므로 설치후 순차적으로 실행되도록 조정이 필요하다.



## 1) Redis cluster architecture



<svg style="left: 0px; top: 0px; width: 100%; height: 100%; display: block; min-width: 764px; min-height: 489px; background-image: none; background-color: transparent;"><defs><filter id="dropShadow"><feGaussianBlur in="SourceAlpha" stdDeviation="1.7" result="blur"></feGaussianBlur><feOffset in="blur" dx="3" dy="3" result="offsetBlur"></feOffset><feFlood flood-color="#3D4574" flood-opacity="0.4" result="offsetColor"></feFlood><feComposite in="offsetColor" in2="offsetBlur" operator="in" result="offsetBlur"></feComposite><feBlend in="SourceGraphic" in2="offsetBlur"></feBlend></filter></defs><g transformorigin="0 0" transform="scale(0.97,0.97)translate(-72,-362)"><g></g><g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="80" y="677" width="640" height="170" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="80" y="400" width="640" height="240" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="305" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="405" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="505" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="605" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="205" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="105" y="550" width="90" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="360" y="770" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 361px; padding: 790px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Redis Client</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="450" y="730" width="110" height="30" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="450" y="730" width="110" height="30" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 452px; padding: 745px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 108px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.x:6379</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 155.36 613.43" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 155.36 613.43" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 150.94 610.6 L 158.72 611.43 L 155.36 613.43 L 154.95 617.32 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="110" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 111px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-0</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="210" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 211px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-1</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="310" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 311px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-2</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="410" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 411px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-3</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="510" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 511px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-4</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="610" y="480" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 611px; padding: 500px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-svc-5</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="110" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 111px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-0</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="210" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 211px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-1</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="310" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 311px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-2</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="410" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 411px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-3</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="510" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 511px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-4</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="610" y="560" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 611px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">redis-pod-5</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="80" y="370" width="90" height="30" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 81px; padding: 385px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 88px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">관리 Cluster</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="749" y="550" width="91" height="60" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="749" y="550" width="91" height="60" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 751px; padding: 580px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 89px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">HostPort: 6379</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 747 550 L 742 550 Q 737 550 737 560 L 737 570 Q 737 580 732 580 L 729.5 580 Q 727 580 732 580 L 734.5 580 Q 737 580 737 590 L 737 600 Q 737 610 742 610 L 747 610" fill="none" stroke="white" stroke-miterlimit="10" transform="translate(737,0)scale(-1,1)translate(-737,0)" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 747 550 L 742 550 Q 737 550 737 560 L 737 570 Q 737 580 732 580 L 729.5 580 Q 727 580 732 580 L 734.5 580 Q 737 580 737 590 L 737 600 Q 737 610 742 610 L 747 610" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" transform="translate(737,0)scale(-1,1)translate(-737,0)" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 254.36 614.65" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 254.36 614.65" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 250.76 610.82 L 258.11 613.53 L 254.36 614.65 L 253 618.32 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 351.9 616.08" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 351.9 616.08" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 350.33 611.07 L 355.76 616.7 L 351.9 616.08 L 349.08 618.79 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 448.1 616.08" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 448.1 616.08" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 449.67 611.07 L 450.92 618.79 L 448.1 616.08 L 444.24 616.7 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 545.64 614.65" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 545.64 614.65" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 549.24 610.82 L 547 618.32 L 545.64 614.65 L 541.89 613.53 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><path d="M 400 770 L 644.64 613.43" fill="none" stroke="white" stroke-miterlimit="10" pointer-events="stroke" visibility="hidden" stroke-width="9"></path><path d="M 400 770 L 644.64 613.43" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 649.06 610.6 L 645.05 617.32 L 644.64 613.43 L 641.28 611.43 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"></path></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="125" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="125" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 127px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.34</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="105" y="530" width="80" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="105" y="530" width="80" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 107px; padding: 540px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 78px; height: 1px;"><div data-drawio-colors="color: #000000; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">worker node</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="230" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="230" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 232px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.61</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="330" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="330" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 332px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.35</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="430" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="430" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 432px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.62</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="530" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="530" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 532px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.36</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="630" y="610" width="65" height="20" fill="none" stroke="white" pointer-events="stroke" visibility="hidden" stroke-width="9"></rect><rect x="630" y="610" width="65" height="20" fill="none" stroke="none" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 632px; padding: 620px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 63px; height: 1px;"><div data-drawio-colors="color: #FF3333; " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: left;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(255, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">10.219.61.63</div></div></div></foreignObject></g></g><g transform="translate(0.5,0.5)" style="visibility: visible;"><rect x="80" y="677" width="120" height="30" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"></rect></g><g style=""><g><foreignObject pointer-events="none" width="100%" height="100%" style="overflow: visible; text-align: left;"><div style="margin: 0px 0px 0px 81px; padding: 692px 0px 0px; display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 0px; text-align: center;"><div style="margin: 0px; padding: 0px; display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">천안/탄방 Cluster</div></div></div></foreignObject></g></g></g><g></g><g></g></g></svg>







## 2) namespace 생성

```sh
$ kubectl create ns redis-cluster

```





## 3) helm chart download



### (1) Repo add

redis-cluster chart 를 가지고 있는 bitnami repogistory 를  helm repo 에 추가한다.

```sh
$ helm repo add bitnami https://charts.bitnami.com/bitnami
$ helm repo list
NAME    URL
bitnami https://charts.bitnami.com/bitnami
```



### (2) Helm Search

추가된 bitnami repo에서 redis-cluster 를 찾는다.

```sh
$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈



$ helm search repo redis

# 2022-06-26
NAME                                            CHART VERSION   APP VERSION     DESCRIPTION
bitnami/redis-cluster                           8.6.1           6.2.7

# 2023-09-03
NAME                                            CHART VERSION   APP VERSION     DESCRIPTION
bitnami/redis                                   17.11.2         7.0.11          Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster                           8.6.1           7.0.11          Redis(R) is an open source, scalable, distribut...


# 2024.03.03
bitnami/redis                                   18.17.0         7.2.4           Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster                           9.7.0           7.2.4           Redis(R) is an open source, scalable, distribut...

# 2024.06.01
bitnami/redis           19.5.0          7.2.5           Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster   10.2.0          7.2.5           Redis(R) is an open source, scalable, distribut...



# 2024.06.27
NAME                 	CHART VERSION	APP VERSION	DESCRIPTION
bitnami/redis        	19.6.0       	7.2.5      	Redis(R) is an open source, advanced key-value ...
bitnami/redis-cluster	10.2.5       	7.2.5      	Redis(R) is an open source, scalable, distribut...


```

우리가 사용할 redis-cluster 버젼은 chart version 8.6.1( app version: 7.0.11) 이다.



### (3) Helm Fetch

helm chart 를 fetch 받는다.

```sh
# chart 를 저장할 적당한 위치로 이동
$ mkdir -p  ~/helm/charts
  cd ~/helm/charts

$ helm fetch bitnami/redis-cluster

$ ll
-rw-r--r-- 1 song song  94737 Jun  1 14:42 redis-cluster-10.2.0.tgz




$ tar -xzvf redis-cluster-10.2.0.tgz
...

$ cd redis-cluster

$ ls -ltr
-rw-r--r-- 1 song song    376 May 24 05:51 .helmignore
-rw-r--r-- 1 song song    231 May 24 05:51 Chart.lock
-rw-r--r-- 1 song song   1043 May 24 05:51 Chart.yaml
-rw-r--r-- 1 song song 118386 May 24 05:51 README.md
drwxrwxr-x 3 song song   4096 Jun  1 14:42 charts/
drwxrwxr-x 2 song song   4096 Jun  1 14:42 templates/
-rw-r--r-- 1 song song  51402 May 24 05:51 values.yaml


```















## 4) Helm Install

**Helm Chart**

```sh
$ cd ~/helm/charts/redis-cluster
 
 
 
 
## 설치1
$ helm -n redis-cluster install ds-redis . \
    --set password=new1234 \
    --set persistence.enabled=true \
    --set metrics.enabled=true \
    --set cluster.nodes=6 \
    --set cluster.replicas=1 \
    --debug --dry-run=true > dry-run_1.yaml

    
    
    # node port 접속시 - redis cluster  에서는 의미 없다.
    --set service.type=NodePort \
    --set service.nodePorts.redis=32300 \




## 설치2
$ helm -n redis-cluster install ds-redis . \
    --set password=new1234 \
    --set persistence.enabled=true \
    --set metrics.enabled=true \
    --set cluster.nodes=6 \
    --set cluster.replicas=1 \
    --set cluster.externalAccess.enabled=true \
    --set cluster.externalAccess.service.type=LoadBalancer \
    --set cluster.externalAccess.service.loadBalancerIP[0]=10.0.0.4  \
    --set cluster.externalAccess.service.loadBalancerIP[1]=10.0.0.5  \
    --set cluster.externalAccess.service.loadBalancerIP[2]=10.0.0.6  \
    --set cluster.externalAccess.service.loadBalancerIP[3]=10.0.0.8  \
    --set cluster.externalAccess.service.loadBalancerIP[4]=10.0.0.9  \
    --set cluster.externalAccess.service.loadBalancerIP[5]=10.0.0.10 \
    --set redis.podManagementPolicy=OrderedReady \
    --set redis.useAOFPersistence=no \
    --dry-run=true > dry-run_1.yaml



NAME: ds-redis
LAST DEPLOYED: Thu Jun 27 07:40:32 2024
NAMESPACE: redis-cluster
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: redis-cluster
CHART VERSION: 10.2.0
APP VERSION: 7.2.5** Please be patient while the chart is being deployed **


To get your password run:
    export REDIS_PASSWORD=$(kubectl get secret --namespace "redis-cluster" ds-redis-redis-cluster -o jsonpath="{.data.redis-password}" | base64 -d)

To connect to your Redis&reg; server from outside the cluster check the following information:

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: 'kubectl get svc --namespace redis-cluster -w ds-redis-redis-cluster'

    You will have a different external IP for each Redis&reg; node. Get the external ip from `-external` suffixed services: `kubectl get svc`.
    Redis&reg; port: 6379INFO: The Job to create the cluster will be created.To connect to your database from outside the cluster execute the following commands:

    export SERVICE_IP=$(kubectl get svc --namespace redis-cluster ds-redis-redis-cluster-0-svc --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
    redis-cli -c -h $SERVICE_IP -p 6379 -a $REDIS_PASSWORD

WARNING: There are "resources" sections in the chart not set. Using "resourcesPreset" is not recommended for production. For production installations, please set the following values according to your workload needs:
  - metrics.resources
  - redis.resources
  - updateJob.resources
+info https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/




## 참조2
$ helm -n redis-cluster install ds-redis . \
    --set password=ss1234! \
    --set persistence.enabled=false \
    --set metrics.enabled=false \
    --set cluster.nodes=6 \
    --set cluster.replicas=1 \
    --set image.registry=nexus.dspace.kt.co.kr \
    --set image.repository=icis/redis-cluster \
    --set image.tag=7.0.9-debian-11-r1 \
    --set cluster.externalAccess.enabled=true \
    --set cluster.externalAccess.service.type=LoadBalancer \
    --set cluster.externalAccess.service.loadBalancerIP[0]=10.219.61.34 \
    --set cluster.externalAccess.service.loadBalancerIP[1]=10.219.61.61 \
    --set cluster.externalAccess.service.loadBalancerIP[2]=10.219.61.35 \
    --set cluster.externalAccess.service.loadBalancerIP[3]=10.219.61.62 \
    --set cluster.externalAccess.service.loadBalancerIP[4]=10.219.61.36 \
    --set cluster.externalAccess.service.loadBalancerIP[5]=10.219.61.63 \
    --set redis.podManagementPolicy=OrderedReady \
    --set redis.useAOFPersistence=no \
    --dry-run=true

    


# 확인
$ helm -n redis-cluster list
NAME    	NAMESPACE    	REVISION	UPDATED                                	STATUS  	CHART               	APP VERSION
ds-redis	redis-cluster	1       	2024-06-26 15:53:13.481769337 +0000 UTC	deployed	redis-cluster-10.2.0	7.2.5


NAME    	NAMESPACE    	REVISION	UPDATED                                	STATUS  	CHART               	APP VERSION
ds-redis	redis-cluster	1       	2024-06-27 07:40:32.212455564 +0000 UTC	deployed	redis-cluster-10.2.0	7.2.5


# 삭제시....
$ helm -n redis-cluster delete ds-redis



```





# 2. hostport 세부 설정



## 1) node 설정



```sh

# node 6개에 label 추가

# node1
metadata:
  labels:
    redis-pod-name: redis-cluster-0
    redis-system: "true"

# node2
metadata:
  labels:
    redis-pod-name: redis-cluster-1
    redis-system: "true"
...
# node6
metadata:
  labels:
    redis-pod-name: redis-cluster-5
    redis-system: "true"

```







## 2) nodeAffinity 설정

statefulset 6개의 pod들이 정해진 node 에 스케쥴링 되도록 설정해야 한다.

redis Cluster 는 hostport 를 통해서 적용되어야 하므로 nodeAffinity 를 사용하여 정해진 node 에 정해진 pod가 뜨도록 유도한다. 

그러므로 POD관리정책은 반드시 Parallel 아 닌 OrderedReady 방식으로 관리되어야 한다.



### 설정1) replicas 0

statefulset replicas = 0 으로 설정



### 설정2) nodeAffinity 설정

statefulset 를 수정한다.



#### hostport 적용

```yaml


# < 적용전 >
      containers:
      ...
        name: ds-redis-redis-cluster
        ...
        ports:
        - containerPort: 6379
          name: tcp-redis
          protocol: TCP
        - containerPort: 16379
          name: tcp-redis-bus
          protocol: TCP
          
# < 적용후 >
      containers:
      ...
        name: ds-redis-redis-cluster
        ...
        ports:
        - containerPort: 6379
          hostPort: 6379
          name: tcp-redis
          protocol: TCP
        - containerPort: 16379
          hostPort: 16379
          name: tcp-redis-bus
          protocol: TCP
          
          
```





#### nodeAffinity

순차적으로 실행되어야 하며 각각 자기 Node IP dp 맞도록 매핑되어야 하므로 아래와 같이 설정한다.

```yaml
    spec:
      affinity:
        nodeAffinity:                            # nodeAffinity 추가
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-0
          - weight: 50
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-1
          - weight: 30
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-2
          - weight: 20
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-3
          - weight: 10
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-4
          - weight: 5
            preference:
              matchExpressions:
              - key: redis-pod-name
                operator: In
                values:
                - redis-cluster-5
```



### 설정3) replicas 원복

statefulset replicas = 6 으로 설정



## 3) Host 와 IP 매핑정보

```sh


# node명과 IP
dio-master01 10.0.0.4   
dio-master02 10.0.0.5 
dio-master03 10.0.0.6 
dio-worker01 10.0.0.8 
dio-worker02 10.0.0.9 
dio-worker03 10.0.0.10

```

















# 3. FailOver Test

Master node 1개를 down 하여 Cluster 가 정상 작동하는지, Slave 가 Master 로 승격되는지 추이를 살펴 본다.



* 테스트 절차

```
1) Cluster node 중 master node down(pod 삭제)
2) cluster nodes 로 Master Node 상태 확인

```





## 1) Master node down



### (1) master node down

```sh
$ redis-cli -h 10.0.0.4 -c -a new1234

# 확인

127.0.0.1:6379> cluster nodes
8fa5e4514ed69e1f2f9685f888639314f9d7d01c 10.0.0.6:6379@16379 master - 0 1719490732000 3 connected 10923-16383
4179bbbbc7ef512ccab5f2b38d58e7f9d1268b41 10.0.0.4:6379@16379 master - 0 1719490731417 1 connected 0-5460
1dbb1226a03e96ea4e7004bf6812824d95e7c256 10.0.0.9:6379@16379 slave 4179bbbbc7ef512ccab5f2b38d58e7f9d1268b41 0 1719490729000 1 connected
c6e8ca284b09b7b5e2254b237cc7d45eb4f95608 10.0.0.8:6379@16379 slave 8fa5e4514ed69e1f2f9685f888639314f9d7d01c 0 1719490732422 3 connected
00c8ebe5cbf94c7f2c7b983e73eee93d20a99dd1 10.0.0.10:6379@16379 slave cdfb751eec4e1de65932cf0c0a0b36aa19aa7ba8 0 1719490733426 2 connected
cdfb751eec4e1de65932cf0c0a0b36aa19aa7ba8 10.0.0.5:6379@16379 myself,master - 0 1719490728000 2 connected 5461-10922



10.0.0.5:6379> cluster nodes
8fa5e4514ed69e1f2f9685f888639314f9d7d01c 10.0.0.6:6379@16379 master - 0 1719491081819 3 connected 10923-16383
4179bbbbc7ef512ccab5f2b38d58e7f9d1268b41 10.0.0.4:6379@16379 master - 0 1719491080000 1 connected 0-5460
1dbb1226a03e96ea4e7004bf6812824d95e7c256 10.0.0.9:6379@16379 slave 4179bbbbc7ef512ccab5f2b38d58e7f9d1268b41 0 1719491082823 1 connected
c6e8ca284b09b7b5e2254b237cc7d45eb4f95608 10.0.0.8:6379@16379 slave 8fa5e4514ed69e1f2f9685f888639314f9d7d01c 0 1719491080000 3 connected
00c8ebe5cbf94c7f2c7b983e73eee93d20a99dd1 10.0.0.10:6379@16379 slave cdfb751eec4e1de65932cf0c0a0b36aa19aa7ba8 0 1719491080814 2 connected
cdfb751eec4e1de65932cf0c0a0b36aa19aa7ba8 10.0.0.5:6379@16379 myself,master - 0 1719491080000 2 connected 5461-10922


10.0.0.4:6379> set a 1
-> Redirected to slot [15495] located at 10.0.0.6:6379
OK
10.0.0.6:6379> set b 2
-> Redirected to slot [3300] located at 10.0.0.4:6379
OK
10.0.0.4:6379> set c 3
-> Redirected to slot [7365] located at 10.0.0.5:6379
OK
10.0.0.5:6379> get a
-> Redirected to slot [15495] located at 10.0.0.6:6379
"1"
10.0.0.6:6379> get b
-> Redirected to slot [3300] located at 10.0.0.4:6379
"2"
10.0.0.4:6379> get c
-> Redirected to slot [7365] located at 10.0.0.5:6379
"3"



# down 대상

# master
8fa5e4514ed69e1f2f9685f888639314f9d7d01c 10.0.0.6:6379@16379 master - 0 1719490732000 3 connected 10923-16383

# slave
c6e8ca284b09b7b5e2254b237cc7d45eb4f95608 10.0.0.8:6379@16379 slave 8fa5e4514ed69e1f2f9685f888639314f9d7d01c 0 1719490732422 3 connected



# c key 가 존재하는 10.0.0.6(Master) 를 down 시켜 보자.

# 아마도 10.0.0.8(Slave) 가 Master 로 승격 될 것이다.

###

# node명과 IP
dio-master01 10.0.0.4   
dio-master02 10.0.0.5 
dio-master03 10.0.0.6 
dio-worker01 10.0.0.8 
dio-worker02 10.0.0.9 
dio-worker03 10.0.0.10




# down 시도
ds-redis-redis-cluster-0 down


###


```



#### Slave node 확인

slave --> master 로 변경된 node log 를 확인해 보자.



먼저 정상적인 로그를 참고하자.

```sh
$ kubectl -n redis-cluster logs ds-redis-redis-cluster-4

1:S 26 Jun 2024 14:40:26.952 * Connecting to MASTER 10.42.0.58:6379
1:S 26 Jun 2024 14:40:26.953 * MASTER <-> REPLICA sync started

# 20초 이후 Cluster fail
1:S 26 Jun 2024 14:40:45.328 * FAIL message received from 20e493acd93e7b5e92dc7dc2b6ea9619c504b245 () about 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f ()
1:S 26 Jun 2024 14:40:45.328 # Cluster state changed: fail
1:S 26 Jun 2024 14:40:45.339 * Start of election delayed for 729 milliseconds (rank #0, offset 2015412).
1:S 26 Jun 2024 14:40:46.143 * Starting a failover election for epoch 11.
1:S 26 Jun 2024 14:40:46.215 * Failover election won: I'm the new master.
1:S 26 Jun 2024 14:40:46.215 * configEpoch set to 11 after successful failover

# 여기서부터 Master 로 변경되었다.
1:M 26 Jun 2024 14:40:46.215 * Discarding previously cached master state.
1:M 26 Jun 2024 14:40:46.215 * Setting secondary replication ID to b2cf60a3a0fd0e89c8e00a3addf88291ff856602, valid up to offset: 2015413. New replication ID is f495d9d5113c51f6fb8b808a847e15745a67f0f8
1:M 26 Jun 2024 14:40:46.215 * Cluster state changed: ok


# cluster ok

```



Slave 로그 - 2024.06.27

```sh
$ kubectl -n redis-cluster logs ds-redis-redis-cluster-4



Cluster state changed: ok
1:S 27 Jun 2024 09:01:37.791 * Non blocking connect for SYNC fired the event.
1:S 27 Jun 2024 09:01:37.791 * Master replied to PING, replication can continue...
1:S 27 Jun 2024 09:01:37.791 * Trying a partial resynchronization (request c535324c7232e05bcc832042f5d59c25be3f965f:1).
1:S 27 Jun 2024 09:01:37.792 * Full resync from master: eb1776b114d3d35ffdda93a55ab40625482cadfe:0
1:S 27 Jun 2024 09:01:37.890 * MASTER <-> REPLICA sync: receiving 171 bytes from master to disk
1:S 27 Jun 2024 09:01:37.890 * Discarding previously cached master state.
1:S 27 Jun 2024 09:01:37.890 * MASTER <-> REPLICA sync: Flushing old data
1:S 27 Jun 2024 09:01:37.890 * MASTER <-> REPLICA sync: Loading DB in memory
1:S 27 Jun 2024 09:01:37.898 * Loading RDB produced by version 7.2.5
1:S 27 Jun 2024 09:01:37.898 * RDB age 0 seconds
1:S 27 Jun 2024 09:01:37.898 * RDB memory usage when created 1.81 Mb
1:S 27 Jun 2024 09:01:37.898 * Done loading RDB, keys loaded: 0, keys expired: 0.
1:S 27 Jun 2024 09:01:37.898 * MASTER <-> REPLICA sync: Finished with success

                      # <-- Master down
1:S 27 Jun 2024 09:12:23.106 * Connection with master lost.
1:S 27 Jun 2024 09:12:23.106 * Caching the disconnected master state.
1:S 27 Jun 2024 09:12:23.106 * Reconnecting to MASTER 10.0.0.6:6379
1:S 27 Jun 2024 09:12:23.107 * MASTER <-> REPLICA sync started
1:S 27 Jun 2024 09:12:23.108 # Error condition on socket for SYNC: Connection refused

1:S 27 Jun 2024 09:12:23.790 * Connecting to MASTER 10.0.0.6:6379
1:S 27 Jun 2024 09:12:23.790 * MASTER <-> REPLICA sync started
1:S 27 Jun 2024 09:12:23.791 # Error condition on socket for SYNC: Connection refused

1:S 27 Jun 2024 09:12:24.797 * Connecting to MASTER 10.0.0.6:6379
1:S 27 Jun 2024 09:12:24.797 * MASTER <-> REPLICA sync started
1:S 27 Jun 2024 09:12:24.799 # Error condition on socket for SYNC: Connection refused

1:S 27 Jun 2024 09:12:25.808 * Connecting to MASTER 10.0.0.6:6379
1:S 27 Jun 2024 09:12:25.808 * MASTER <-> REPLICA sync started
1:S 27 Jun 2024 09:12:25.809 # Error condition on socket for SYNC: Connection refused

1:S 27 Jun 2024 09:12:26.877 * Connecting to MASTER 10.0.0.6:6379
1:S 27 Jun 2024 09:12:26.878 * MASTER <-> REPLICA sync started
1:S 27 Jun 2024 09:12:26.880 * Non blocking connect for SYNC fired the event.
1:S 27 Jun 2024 09:12:26.881 * Master replied to PING, replication can continue...
1:S 27 Jun 2024 09:12:26.882 * Trying a partial resynchronization (request eb1776b114d3d35ffdda93a55ab40625482cadfe:933).
1:S 27 Jun 2024 09:12:26.883 * Full resync from master: 4836e381f695aec72f59a06d0691f5ce48fcbb8c:0
1:S 27 Jun 2024 09:12:26.948 * MASTER <-> REPLICA sync: receiving 171 bytes from master to disk

1:S 27 Jun 2024 09:12:26.948 * Discarding previously cached master state.
1:S 27 Jun 2024 09:12:26.948 * MASTER <-> REPLICA sync: Flushing old data
1:S 27 Jun 2024 09:12:26.948 * MASTER <-> REPLICA sync: Loading DB in memory

1:S 27 Jun 2024 09:12:26.957 * Loading RDB produced by version 7.2.5
1:S 27 Jun 2024 09:12:26.957 * RDB age 0 seconds
1:S 27 Jun 2024 09:12:26.957 * RDB memory usage when created 1.59 Mb
1:S 27 Jun 2024 09:12:26.957 * Done loading RDB, keys loaded: 0, keys expired: 0.
1:S 27 Jun 2024 09:12:26.957 * MASTER <-> REPLICA sync: Finished with success



```





위와 동일한 현상 분석 

https://github.com/bitnami/charts/issues/15384











### (2) redis-cli 확인



계속 get 명령 수행해보자.

```sh

10.42.0.51:6379>  get a
-> Redirected to slot [15495] located at 10.42.1.55:6379
"11"
10.42.1.55:6379> get b
-> Redirected to slot [3300] located at 10.42.2.67:6379
"22"
10.42.2.67:6379> get c
-> Redirected to slot [7365] located at 10.42.0.51:6379
"33"





```



새로운 connection 으로 접근해보자.

```sh
$ redis-cli -h ds-redis-redis-cluster -c -a new1234


10.42.0.51:6379> cluster nodes
758ce5e964955785008c38e00ad938fb3858d160 10.42.2.67:6379@16379 master - 0 1719413326000 10 connected 0-5460
8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f 10.42.0.58:6379@16379 master,fail - 1719412829159 1719412824000 3 connected
a3751c0035c4c96e6f8f0fe8dcf6ea91eaead590 10.42.1.72:6379@16379 slave 758ce5e964955785008c38e00ad938fb3858d160 0 1719413330268 10 connected
97ba88317484669484e1b7c82167e61971b560d8 10.42.2.68:6379@16379 slave 20e493acd93e7b5e92dc7dc2b6ea9619c504b245 0 1719413328256 7 connected
2305d0d3970436ad3ea47c8780ca7c0044fe993d 10.42.1.55:6379@16379 master - 0 1719413329262 11 connected 10923-16383
20e493acd93e7b5e92dc7dc2b6ea9619c504b245 10.42.0.51:6379@16379 myself,master - 0 1719413327000 7 connected 5461-10922




```

10.42.1.55 node 가 slave 에서 master 로 승격되었다.

하지만 기존에 down된 node 는 fail 로 남아 있다.

get 명령을 수행해보자.

```sh
10.42.0.51:6379> get c
"33"
10.42.0.51:6379>  get a
-> Redirected to slot [15495] located at 10.42.1.55:6379
"11"
10.42.1.55:6379> get b
-> Redirected to slot [3300] located at 10.42.2.67:6379
"22"
10.42.2.67:6379> get c
-> Redirected to slot [7365] located at 10.42.0.51:6379
"33"
```



새로운 connection 은 문제가 없다.

Fail Node 는 어떻게 정상화 시킬 수 있을까?  (task 1)

기존 connection 에서 Redis 가 정상화 되었을때 문제 없이 connect 되어야 하는데 어떻게 해결 할수 있을까?  (task 2)



#### [참고] redis-cli  지속 실행

```sh
## redis-client 로 접근
$ oc -n redis-poc exec -it deploy/redis-client -- bash

# data read 확인
$ redis-cli -h sa-redisin-redis-cluster -c -a new1234 get a
$ redis-cli -h sa-redisin-redis-cluster -c -a new1234 get b
$ redis-cli -h sa-redisin-redis-cluster -c -a new1234 get c


# 1초에 한번씩 get 실행
$ while true; do date; \
    redis-cli -h sa-redisin-redis-cluster -c -a new1234 get a; \
    redis-cli -h sa-redisin-redis-cluster -c -a new1234 get b; \
    redis-cli -h sa-redisin-redis-cluster -c -a new1234 get c; echo; sleep 1; done

```









### (3) python 테스트



```python
# redis set
rc.set("a", "python1")
rc.set("b", "python2")
rc.set("c", "python3")



# 1초에 한번씩 get 실행
from time import sleep

for i in range(10000):
    print(i)
    sleep(1)
    rc.get("a")
    rc.get("b")
    rc.get("c")
    

# down 발생시점에서 약 20초정도 이후 정상작동한다.

```









### (4) Fail Node 확인



#### pod not ready 확인

pod 를 확인해 보자.

```sh
$ krs get pod
NAME                            READY   STATUS    RESTARTS   AGE
python-7d59455985-scgxb         2/2     Running   0          3d8h
ds-redis-redis-cluster-2      1/1     Running   0          36m
ds-redis-redis-cluster-3      1/1     Running   0          36m
ds-redis-redis-cluster-4      1/1     Running   0          36m
ds-redis-redis-cluster-5      1/1     Running   0          36m
ds-redis-redis-cluster-0      1/1     Running   0          36m
redis-client-69dcc9c76d-g6sms   1/1     Running   0          35m
ds-redis-redis-cluster-1      0/1     Running   0          22m

```

down 이후 자동 재기동된 pod가 readiness 를 통과하지 못했다. 

원인이 무엇인지 확인해보자.



아래는 readinessprobe 명령이다.

```yaml
                                                                                                           │
│     readinessProbe:                                                                                                            │
│       exec:                                                                                                                    │
│         command:                                                                                                               │
│         - sh                                                                                                                   │
│         - -c                                                                                                                   │
│         - /scripts/ping_readiness_local.sh 1                                                                                   │
│       failureThreshold: 5                                                                                                      │
│       initialDelaySeconds: 5                                                                                                   │
│       periodSeconds: 5                                                                                                         │
│       successThreshold: 1                                                                                                      │
│       timeoutSeconds: 2  
```



ping_readiness_local.sh 값을 확인해보자.

```shell
$ cat /scripts/ping_readiness_local.sh
#!/bin/sh
set -e

REDIS_STATUS_FILE=/tmp/.redis_cluster_check
if [ ! -z "$REDIS_PASSWORD" ]; then export REDISCLI_AUTH=$REDIS_PASSWORD; fi;
response=$(
  timeout -s 15 $1 \
  redis-cli \
    -h localhost \
    -p $REDIS_PORT_NUMBER \
    ping
)
if [ "$?" -eq "124" ]; then
  echo "Timed out"
  exit 1
fi
if [ "$response" != "PONG" ]; then
  echo "$response"
  exit 1
fi
if [ ! -f "$REDIS_STATUS_FILE" ]; then
  response=$(
    timeout -s 15 $1 \
    redis-cli \
      -h localhost \
      -p $REDIS_PORT_NUMBER \
      CLUSTER INFO | grep cluster_state | tr -d '[:space:]'
  )
  if [ "$?" -eq "124" ]; then
    echo "Timed out"
    exit 1
  fi
  if [ "$response" != "cluster_state:ok" ]; then
    echo "$response"
    exit 1
  else
    touch "$REDIS_STATUS_FILE"
  fi

```





fail node 에서 확인해보자.

```sh
$ sh -c "/scripts/ping_readiness_local.sh 1"
cluster_state:fail

# 실패한다.



# 패스워드는 정상
$ echo $REDIS_PASSWORD
new1234

$ echo $REDIS_PORT_NUMBER
6379


# ping pong test
$ redis-cli \
    -h localhost \
    -p 6379 \
    ping
PONG


# cluster info 확인 1
$ redis-cli \
      -h localhost \
      -p $REDIS_PORT_NUMBER \
      CLUSTER INFO

cluster_state:fail
cluster_slots_assigned:0
cluster_slots_ok:0
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:1
cluster_size:0
cluster_current_epoch:0
cluster_my_epoch:0
cluster_stats_messages_sent:0
cluster_stats_messages_received:0
total_cluster_links_buffer_limit_exceeded:0


# cluster info 확인 2
$ redis-cli \
      -h localhost \
      -p $REDIS_PORT_NUMBER \
      CLUSTER INFO | grep cluster_state | tr -d '[:space:]'

cluster_state:fail



```



결국 cluster_state 가 실패하여 not ready 되었다.





#### container 시작 명령 확인



```yaml
  containers:
  - args:
    - |
      # Backwards compatibility change
      if ! [[ -f /opt/bitnami/redis/etc/redis.conf ]]; then
          echo COPYING FILE
          cp  /opt/bitnami/redis/etc/redis-default.conf /opt/bitnami/redis/etc/redis.conf
      fi
      pod_index=($(echo "$POD_NAME" | tr "-" "\n"))
      pod_index="${pod_index[-1]}"
      if [[ "$pod_index" == "0" ]]; then
        export REDIS_CLUSTER_CREATOR="yes"
        export REDIS_CLUSTER_REPLICAS="1"
      fi
      /opt/bitnami/scripts/redis-cluster/entrypoint.sh /opt/bitnami/scripts/redis-cluster/run.sh
    command:
    - /bin/bash
    - -c

```





#### Fail node 확인

```sh
10.42.0.132:6379> cluster nodes
bf04da290df7003c4dacb45cbdf2ac40d696663c 10.42.0.131:6379@16379 slave 9d6c30fdada95856e40e1634c51113a85dd50c53 0 1689169951000 1 connected
37ede9c99774fcdb6ad3b34f7d681061244fba93 10.42.0.128:6379@16379 master,fail - 1689167922262 1689167919000 2 connected
9fa9dc6cab3398624df40713b4bc675b1322184c 10.42.0.129:6379@16379 master - 0 1689169953754 3 connected 10923-16383
77b47a2e6cd38a19ce7b71eaf142b0ef87de16b9 10.42.0.132:6379@16379 myself,master - 0 1689169951000 7 connected 5461-10922
9d6c30fdada95856e40e1634c51113a85dd50c53 10.42.0.127:6379@16379 master - 0 1689169952749 1 connected 0-5460
ff84e2066b155907cf0981f9c37bbc2686d8c880 10.42.0.130:6379@16379 slave 9fa9dc6cab3398624df40713b4bc675b1322184c 0 1689169952000 3 connected

```





### (5) 결론

* slave 가 master 로 승격되어 서비스는 정상 작동한다.
* 재기동된 기존의 node 는 자동으로 slave 로 추가되지 않는다.
* 그러므로 수작업으로 추가작업 해야 한다.





## 2) Fail Over 처리

Fail node 를 추방하고 기존 node 는 slave node로 추가하는 작업을 수행한다.



참고: 

https://mozi.tistory.com/382



### (1) FailOver with meet-replicate



* 순서

```
1) forget 명령으로 해당노드를 group에서 제거한다.
2) meet 명령으로 node 추가
   - 일반적으로 master node 로 추가된다.  그러므로 slave 로 변경해 줘야 한다.
3) replicate 명령으로 slave 설정을 한다.
```



```sh
# 작업전
127.0.0.1:6379> cluster nodes
e649c433897a81b736cc9b4de898756e8a7fb182 10.0.0.9:6379@16379 myself,slave 9f4c33e0432d522717f6009f959059e191538088 0 1719488012000 1 connected
9f4c33e0432d522717f6009f959059e191538088 :0@0 master,noaddr - 1719487446852 1719487442126 1 disconnected 0-5460
ba4be38cda123bd1754396407f77dc519f1894a7 10.0.0.8:6379@16379 slave 7ae7ea2c85f34d609796f694c8ffd054c33b7a81 0 1719488013000 3 connected
6cc7fb979b91eee05c0cf8f673a9fca8d2c4fc31 10.0.0.10:6379@16379 slave bdf03137f1182a53d3db2bc589da23e1613c0841 0 1719488015000 2 connected
bdf03137f1182a53d3db2bc589da23e1613c0841 10.0.0.5:6379@16379 master - 0 1719488014000 2 connected 5461-10922
7ae7ea2c85f34d609796f694c8ffd054c33b7a81 10.0.0.6:6379@16379 master - 0 1719488015616 3 connected 10923-16383


# 1) forget
## 모든 node 에서 1분이내에 수행해야 한다.
## 그렇지 않으면 gosship protocol에 의해서 원복된다.

$ export REDIS_PASSWORD=new1234

$ 
redis-cli -h 10.0.0.4  -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088
redis-cli -h 10.0.0.5  -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088
redis-cli -h 10.0.0.6  -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088
redis-cli -h 10.0.0.8  -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088
redis-cli -h 10.0.0.9  -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088
redis-cli -h 10.0.0.10 -c -a $REDIS_PASSWORD cluster forget 9f4c33e0432d522717f6009f959059e191538088


redis-cli -h ds-redis-redis-cluster-0.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f
redis-cli -h ds-redis-redis-cluster-1.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f
redis-cli -h ds-redis-redis-cluster-2.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f
redis-cli -h ds-redis-redis-cluster-3.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f
redis-cli -h ds-redis-redis-cluster-4.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f
redis-cli -h ds-redis-redis-cluster-5.ds-redis-redis-cluster-headless -c -a $REDIS_PASSWORD cluster forget 8de5a8f7816480b1b0e8dadd25c9c0c53271ee9f

OK







# 2) meet
##   재기동된 신규 pod의 IP를 확인한다.
$ redis-cli -h ds-redis-redis-cluster -a $REDIS_PASSWORD CLUSTER meet 10.42.4.3 6379

# or
$ CLUSTER meet 10.0.0.4 6379

ds-redis-redis-cluster:6379> cluster nodes
2305d0d3970436ad3ea47c8780ca7c0044fe993d 10.42.1.55:6379@16379 master - 0 1719413980000 11 connected 10923-16383
97ba88317484669484e1b7c82167e61971b560d8 10.42.2.68:6379@16379 slave 20e493acd93e7b5e92dc7dc2b6ea9619c504b245 0 1719413980900 7 connected
a3751c0035c4c96e6f8f0fe8dcf6ea91eaead590 10.42.1.72:6379@16379 myself,slave 758ce5e964955785008c38e00ad938fb3858d160 0 1719413979000 10 connected
758ce5e964955785008c38e00ad938fb3858d160 10.42.2.67:6379@16379 master - 0 1719413979000 10 connected 0-5460
1eaa01b02d0f7c6e4f8254210d150cc54c4241c4 10.42.4.3:6379@16379 master - 0 1719413978000 0 connected
20e493acd93e7b5e92dc7dc2b6ea9619c504b245 10.42.0.51:6379@16379 master - 0 1719413979895 7 connected 5461-10922


# 3) replicate
## REPLICAS <node-id>
##    Return <node-id> replicas.
## replicate 명령은 자신을 지정한 node-id의 슬레이브로 만드는 명령이다.
## 그러므로 replica node 로 login 한다음 master node-id 를 설정한다.
$ redis-cli -h localhost -c -a $REDIS_PASSWORD CLUSTER REPLICATE 2305d0d3970436ad3ea47c8780ca7c0044fe993d


# 작업후
ds-redis-redis-cluster:6379> cluster nodes
2305d0d3970436ad3ea47c8780ca7c0044fe993d 10.42.1.55:6379@16379 master - 0 1719414067691 11 connected 10923-16383
97ba88317484669484e1b7c82167e61971b560d8 10.42.2.68:6379@16379 slave 20e493acd93e7b5e92dc7dc2b6ea9619c504b245 0 1719414066636 7 connected
a3751c0035c4c96e6f8f0fe8dcf6ea91eaead590 10.42.1.72:6379@16379 myself,slave 2305d0d3970436ad3ea47c8780ca7c0044fe993d 0 1719414066000 11 connected
758ce5e964955785008c38e00ad938fb3858d160 10.42.2.67:6379@16379 master - 0 1719414067000 10 connected 0-5460
1eaa01b02d0f7c6e4f8254210d150cc54c4241c4 10.42.4.3:6379@16379 master - 0 1719414068702 0 connected
20e493acd93e7b5e92dc7dc2b6ea9619c504b245 10.42.0.51:6379@16379 master - 0 1719414067000 7 connected 5461-10922

```







### (2) FiailOver with add-node

* 순서

```
1) forget 명령으로 해당노드를 group에서 제거한다.
2) add-node 옵션으로 Slave Node 추가
```



```sh
# 샘플
$ redis-cli --cluster \
    add-node 127.0.0.1:7001 127.0.0.1:7000 \
    --cluster-slave 869859e396c881b3c26f2a386c1495235225b57b

# 작업전
127.0.0.1:6379> cluster nodes
634e839e0e616f4a2b52e940e29b0fe042a31697 10.0.0.5:6379@16379 master - 0 1719486882000 2 connected 5461-10922
f199864362dccd801871f1cc94c9ce234389bb9a 10.0.0.4:6379@16379 master - 0 1719486882483 1 connected 0-5460
b7cf9f74e286fe43b432e85045c49b7c2957fc80 :0@0 master,noaddr - 1719479546376 1719479542000 3 disconnected 10923-16383
f2e2150ec47958f545dddf4e1ed9657a96187d93 10.0.0.8:6379@16379 myself,slave 4fdc86c0d1f290b828118a4055451a4641caaa2d 0 1719486883000 0 connected
6e35cf41c795aa90dee006f2506418f586039efb 10.0.0.10:6379@16379 slave 634e839e0e616f4a2b52e940e29b0fe042a31697 0 1719486882000 2 connected
4fdc86c0d1f290b828118a4055451a4641caaa2d 10.0.0.6:6379@16379 master - 0 1719486883486 0 connected
daa9ffdd6b78e13156c3dd80f66386df3d0ceca9 10.0.0.9:6379@16379 slave f199864362dccd801871f1cc94c9ce234389bb9a 0 1719486880000 1 connected


# 1) forget
## 모든 node 에서 1분이내에 수행해야 한다.
## 그렇지 않으면 gosship protocol에 의해서 원복된다.

export REDIS_PASSWORD=new1234

$ 
redis-cli -h 10.0.0.4  -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80
redis-cli -h 10.0.0.5  -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80
redis-cli -h 10.0.0.6  -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80
redis-cli -h 10.0.0.8  -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80
redis-cli -h 10.0.0.9  -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80
redis-cli -h 10.0.0.10 -c -a $REDIS_PASSWORD cluster forget b7cf9f74e286fe43b432e85045c49b7c2957fc80

OK


# 2) add-node
## format
## [슬레이브 IP:PORT] , [클러스터 노드 IP:PORT], [--cluster-slave 옵션], [마스터가 될 노드 ID]

$ redis-cli -a new1234 \
    --cluster add-node 10.42.0.175:6379 10.42.0.172:6379 \
    --cluster-slave b109ed74a0e639d34067d1bf78a860931d0ee941


# 작업후
$ cluster nodes
ac04246dfccf850cbdf78565a52f131b1160233a 10.42.0.175:6379@16379 slave b109ed74a0e639d34067d1bf78a860931d0ee941 0 1689470266001 8 connected
0da823d72181e684dfaf1b0c9cc9b58be96675ce 10.42.0.173:6379@16379 slave 95acfe21a64250fa3359eb10e5f9cd23d38ec36c 0 1689470264000 7 connected
da5aaba2df35da46204ff96eb4be853ccd507606 10.42.0.174:6379@16379 slave 12a06ae7cd0ae7efd267814e28a83ff7824b8178 0 1689470264996 2 connected
b109ed74a0e639d34067d1bf78a860931d0ee941 10.42.0.172:6379@16379 myself,master - 0 1689470262000 8 connected 0-5460
12a06ae7cd0ae7efd267814e28a83ff7824b8178 10.42.0.170:6379@16379 master - 0 1689470264000 2 connected 5461-10922
95acfe21a64250fa3359eb10e5f9cd23d38ec36c 10.42.0.168:6379@16379 master - 0 1689470263990 7 connected 10923-16383

```













# 4. 테스트결론



Host port 인 상태에서 테스트 결과...



* pv 가 있다면 
  * master 를 down 하더라도 문제없이 재기동된다.
  * Aof false 라도 마찬가지이다.
* PV 가 없다면
  * master down 시 클러스터가 망가진다.
  * master 를 추방하고 slave 를 master 로 승격하는 작업을 수작업으로 진행해야 하나
  * 이 작업도 잘 수행되지 않는다.



그러므로 PV 를 붙여서 사용하는 방안으로 가려면...

* AOF 존재여부에 따라 얼마나 데이터가 증가되는지 추이 분석 필요

* 주기적으로 Dump 작업 수행







# 5. AP Test

### pom.xml

```xml
...
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
...
```

### application.yml

```yaml

...
spring:  
  data:
    redis:
      cluster:
        nodes:
          - redis-redis-cluster-0.redis-redis-cluster-headless.redis-system:6379
          - redis-redis-cluster-1.redis-redis-cluster-headless.redis-system:6379
          - redis-redis-cluster-2.redis-redis-cluster-headless.redis-system:6379
          - redis-redis-cluster-3.redis-redis-cluster-headless.redis-system-headless.redis-system:6379
          - redis-redis-cluster-5.redis-redis-cluster-headless.redis-system:6379
...
```

### RedisClusterConfigurationProperties.java

```java
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
 
import lombok.Getter;
import lombok.Setter;
 
import java.util.List;
 
@Component
@Setter
@Getter
@ConfigurationProperties(prefix = "spring.data.redis.cluster")
public class RedisClusterConfigurationProperties {
   List<String> nodes;
}
```

### RedisClusterConfig.java

```java
package icis.kt.co.kr.redis_test.cmmn;
 
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.redis.connection.RedisClusterConfiguration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.repository.configuration.EnableRedisRepositories;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;
import lombok.RequiredArgsConstructor;
 
@Configuration
@EnableRedisRepositories
@RequiredArgsConstructor
public class RedisClusterConfig {
 
    @Autowired
    RedisClusterConfigurationProperties clusterProperties;
 
    @Bean(name = "redisConnectionFactory")
    public RedisConnectionFactory redisConnectionFactory() {
        RedisClusterConfiguration redisConfig = new RedisClusterConfiguration();
        clusterProperties.getNodes().forEach(s -> {
            String[] url = s.split(":");
            redisConfig.clusterNode(url[0], Integer.parseInt(url[1]));
        });
        redisConfig.setUsername("");
        redisConfig.setPassword("");
        return new LettuceConnectionFactory(redisConfig);
    }
 
    @Primary   
    @Bean(name = "redisObjectTemplate")
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer<>(Object.class));
        return redisTemplate;
    }
 
}
```

이후 RedisOperator부터 는 온라인 가이드(DEV)와 동일하다.